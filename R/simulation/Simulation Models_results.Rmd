---
title: "Simulation Model Results"
author: "Ze Yu Zhong"
date: "21/07/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
################
##Load Libraries
################

library(tidyverse)
library(keras)
library(quantreg)
library(ggplot2)
library(forecast)
library(rlist)
library(Metrics)
library(ranger)
library(caret)
library(forcats)
library(xtable)
library(randomForestSRC)

#Parallel Computing
library(foreach)
library(doFuture)
#Registering
registerDoFuture()
plan(multisession)

set.seed(27935248)
```

```{r load_final_results}
## Chunk to load final results list (just load this to avoid bothering with combining different results list)

g1_A1_nosv_0_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g1_A1_nosv_0_results_all.RDS")
g2_A1_nosv_0_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g2_A1_nosv_0_results_all.RDS")
g3_A1_nosv_0_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g3_A1_nosv_0_results_all.RDS")

g1_A1_sv_0.01_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g1_A1_sv_0.01_results_all.RDS")
g2_A1_sv_0.01_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g2_A1_sv_0.01_results_all.RDS")
g3_A1_sv_0.01_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g3_A1_sv_0.01_results_all.RDS")

g1_A1_sv_0.1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g1_A1_sv_0.1_results_all.RDS")
g2_A1_sv_0.1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g2_A1_sv_0.1_results_all.RDS")
g3_A1_sv_0.1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g3_A1_sv_0.1_results_all.RDS")

g1_A1_sv_1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g1_A1_sv_1_results_all.RDS")
g2_A1_sv_1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g2_A1_sv_1_results_all.RDS")
g3_A1_sv_1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g3_A1_sv_1_results_all.RDS")
```

```{r performance_functions}
## For a given simulation results list, collect all the loss dataframes into a big, tidy DF for a SINGLE realization

gen_tidy_loss_df <- function(simulation_results_list, realization_no, dgp_spec, SV, cross_corr) {
  df <- foreach(sample = (1:3), .combine = "rbind") %do% {
    rbind(
      cbind(model = "LM_MSE", sample = sample, simulation_results_list[[realization_no]]$LM_MSE[[sample]]$loss_stats),
      cbind(model = "LM_MAE", sample = sample, simulation_results_list[[realization_no]]$LM_MAE[[sample]]$loss_stats),
      
      ################################################################################################
      
      cbind(model = "ELN_MSE", sample = sample, simulation_results_list[[realization_no]]$ELN_MSE[[sample]]$loss_stats),
      cbind(model = "ELN_MAE", sample = sample, simulation_results_list[[realization_no]]$ELN_MAE[[sample]]$loss_stats),
      
      ################################################################################################
      
      cbind(model = "RF_MSE", sample = sample, simulation_results_list[[realization_no]]$RF_MSE[[sample]]$loss_stats),
      cbind(model = "RF_MAE", sample = sample, simulation_results_list[[realization_no]]$RF_MAE[[sample]]$loss_stats),
      
      ################################################################################################
      
      cbind(model = "NN1_MSE", sample = sample, simulation_results_list[[realization_no]]$NN1_MSE[[sample]]$loss_stats),
      cbind(model = "NN1_MAE", sample = sample, simulation_results_list[[realization_no]]$NN1_MAE[[sample]]$loss_stats),

      cbind(model = "NN2_MSE", sample = sample, simulation_results_list[[realization_no]]$NN2_MSE[[sample]]$loss_stats),
      cbind(model = "NN2_MAE", sample = sample, simulation_results_list[[realization_no]]$NN2_MAE[[sample]]$loss_stats),

      cbind(model = "NN3_MSE", sample = sample, simulation_results_list[[realization_no]]$NN3_MSE[[sample]]$loss_stats),
      cbind(model = "NN3_MAE", sample = sample, simulation_results_list[[realization_no]]$NN3_MAE[[sample]]$loss_stats),

      cbind(model = "NN4_MSE", sample = sample, simulation_results_list[[realization_no]]$NN4_MSE[[sample]]$loss_stats),
      cbind(model = "NN4_MAE", sample = sample, simulation_results_list[[realization_no]]$NN4_MAE[[sample]]$loss_stats),

      cbind(model = "NN5_MSE", sample = sample, simulation_results_list[[realization_no]]$NN5_MSE[[sample]]$loss_stats),
      cbind(model = "NN5_MAE", sample = sample, simulation_results_list[[realization_no]]$NN5_MAE[[sample]]$loss_stats)
    )
  }
  cbind(realization_no = realization_no, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, df)
}

# Function to iterate over all realizations

all_realize_loss_df <- function(simulation_results_list, dgp_spec, SV, cross_corr) {
  foreach(realization_no = (1:10), .combine = "rbind") %do% {
    gen_tidy_loss_df(simulation_results_list, realization_no, dgp_spec, SV, cross_corr)
  }
}

all_loss_df <- rbind(
  all_realize_loss_df(g1_A1_nosv_0_results_all, dgp_spec = "g1", SV = 0, cross_corr = 0),
  all_realize_loss_df(g2_A1_nosv_0_results_all, dgp_spec = "g2", SV = 0, cross_corr = 0),
  all_realize_loss_df(g3_A1_nosv_0_results_all, dgp_spec = "g3", SV = 0, cross_corr = 0),
  
  all_realize_loss_df(g1_A1_sv_0.01_results_all, dgp_spec = "g1", SV = 1, cross_corr = 0.01),
  all_realize_loss_df(g2_A1_sv_0.01_results_all, dgp_spec = "g2", SV = 1, cross_corr = 0.01),
  all_realize_loss_df(g3_A1_sv_0.01_results_all, dgp_spec = "g3", SV = 1, cross_corr = 0.01),
  
  all_realize_loss_df(g1_A1_sv_0.1_results_all, dgp_spec = "g1", SV = 1, cross_corr = 0.1),
  all_realize_loss_df(g2_A1_sv_0.1_results_all, dgp_spec = "g2", SV = 1, cross_corr = 0.1),
  all_realize_loss_df(g3_A1_sv_0.1_results_all, dgp_spec = "g3", SV = 1, cross_corr = 0.1),
  
  all_realize_loss_df(g1_A1_sv_1_results_all, dgp_spec = "g1", SV = 1, cross_corr = 1),
  all_realize_loss_df(g2_A1_sv_1_results_all, dgp_spec = "g2", SV = 1, cross_corr = 1),
  all_realize_loss_df(g3_A1_sv_1_results_all, dgp_spec = "g3", SV = 1, cross_corr = 1)
)

all_loss_df_averaged <- all_loss_df %>%
  group_by(model, dgp_spec, sample, SV, cross_corr) %>%
  summarise(train_MAE = mean(train_MAE), train_MSE = mean(train_MSE), 
            train_RMSE = mean(train_RMSE), train_RSquare = mean(train_RSquare),
            
            validation_MAE = mean(validation_MAE), validation_MSE = mean(validation_MSE), 
            validation_RMSE = mean(validation_RMSE), validation_RSquare = mean(validation_RSquare),
              
            test_MAE = mean(test_MAE), test_MSE = mean(test_MSE), 
            test_RMSE = mean(test_RMSE), test_RSquare = mean(test_RSquare)
            )

## Save to csv

write.csv(all_loss_df_averaged, file = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_loss_averaged.csv")
write.csv(all_loss_df, file = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_loss.csv")

#############################################################################
# Function to collate variable importance

normalize_variable_importance <- function(variable_importance_df) {
  variable_importance_df %>%
    # Add a very very tiny value so that division by zero does not occur
    mutate(importance = importance + 1e-100) %>%
    mutate(importance = importance + abs(min(importance))) %>%
    mutate(importance = importance/sum(importance))
}

gen_tidy_vi <- function(simulation_results_list, realization_no, dgp_spec, SV, cross_corr) {
  df <- foreach(sample = 1:3, .combine = "rbind") %do% {
    rbind(
      cbind(model = "LM_MSE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$LM_MSE[[sample]]$variable_importance)),
      cbind(model = "LM_MAE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$LM_MAE[[sample]]$variable_importance)),
      
      ################################################################################################
      
      cbind(model = "ELN_MSE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$ELN_MSE[[sample]]$variable_importance)),
      cbind(model = "ELN_MAE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$ELN_MAE[[sample]]$variable_importance)),
      
      ################################################################################################
      
      cbind(model = "RF_MSE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$RF_MSE[[sample]]$variable_importance)),
      cbind(model = "RF_MAE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$RF_MAE[[sample]]$variable_importance)),
      
      ################################################################################################
      
      cbind(model = "NN1_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN1_MSE[[sample]]$variable_importance)),
      cbind(model = "NN1_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN1_MAE[[sample]]$variable_importance)),

      cbind(model = "NN2_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN2_MSE[[sample]]$variable_importance)),
      cbind(model = "NN2_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN2_MAE[[sample]]$variable_importance)),

      cbind(model = "NN3_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN3_MSE[[sample]]$variable_importance)),
      cbind(model = "NN3_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN3_MAE[[sample]]$variable_importance)),

      cbind(model = "NN4_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN4_MSE[[sample]]$variable_importance)),
      cbind(model = "NN4_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN4_MAE[[sample]]$variable_importance)),

      cbind(model = "NN5_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN5_MSE[[sample]]$variable_importance)),
      cbind(model = "NN5_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN5_MAE[[sample]]$variable_importance))
    )
  }
  cbind(realization_no = realization_no, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, df)
}

# Iterate over all realizations

all_realize_vi <- function(simulation_results_list, dgp_spec, SV, cross_corr) {
  foreach(realization_no = (1:10), .combine = "rbind") %do% {
    gen_tidy_vi(simulation_results_list, realization_no, dgp_spec, SV, cross_corr)
  }
}

all_vi_df <- rbind(
  all_realize_vi(g1_A1_nosv_0_results_all, dgp_spec = "g1", SV = 0, cross_corr = 0),
  all_realize_vi(g2_A1_nosv_0_results_all, dgp_spec = "g2", SV = 0, cross_corr = 0),
  all_realize_vi(g3_A1_nosv_0_results_all, dgp_spec = "g3", SV = 0, cross_corr = 0),
  
  all_realize_vi(g1_A1_sv_0.01_results_all, dgp_spec = "g1", SV = 1, cross_corr = 0.01),
  all_realize_vi(g2_A1_sv_0.01_results_all, dgp_spec = "g2", SV = 1, cross_corr = 0.01),
  all_realize_vi(g3_A1_sv_0.01_results_all, dgp_spec = "g3", SV = 1, cross_corr = 0.01),
  
  all_realize_vi(g1_A1_sv_0.1_results_all, dgp_spec = "g1", SV = 1, cross_corr = 0.1),
  all_realize_vi(g2_A1_sv_0.1_results_all, dgp_spec = "g2", SV = 1, cross_corr = 0.1),
  all_realize_vi(g3_A1_sv_0.1_results_all, dgp_spec = "g3", SV = 1, cross_corr = 0.1),
  
  all_realize_vi(g1_A1_sv_1_results_all, dgp_spec = "g1", SV = 1, cross_corr = 1),
  all_realize_vi(g2_A1_sv_1_results_all, dgp_spec = "g2", SV = 1, cross_corr = 1),
  all_realize_vi(g3_A1_sv_1_results_all, dgp_spec = "g3", SV = 1, cross_corr = 1)
)

all_vi_df_averaged <- all_vi_df %>%
  group_by(model, dgp_spec, sample, SV, cross_corr, variable) %>%
  summarise(importance = mean(importance))
```

```{r prediction_performance_plots}
## Prediction Performance Plots

a4_aspect_ratio <- 1.5

################################################################
# Training Statistics
all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ggplot() +
  geom_bar(aes(x = model, y = train_MAE, fill = sample), stat = "identity", position = position_dodge()) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_train_mae.pdf")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ggplot() +
  geom_bar(aes(x = model, y = train_MSE, fill = sample), stat = "identity", position = position_dodge()) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_train_mse.pdf")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ggplot() +
  geom_bar(aes(x = model, y = train_RSquare, fill = sample), stat = "identity", position = position_dodge()) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_train_rsquare.pdf")
```

```{r}
#######################################################################
# Test Statistics

breaks <- levels(all_loss_df_averaged$model)
labels <- as.expression(breaks)
labels[[2]] <- bquote(bold(.(labels[[2]])))
labels[[4]] <- bquote(bold(.(labels[[4]])))
labels[[6]] <- bquote(bold(.(labels[[6]])))
labels[[16]] <- bquote(bold(.(labels[[16]])))

## Plots showing that quantile loss is better
all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  filter(model == "LM_MAE" | model == "LM_MSE" 
         | model == "ELN_MAE" | model == "ELN_MSE"
         | model == "RF_MAE" | model == "RF_MSE"
         | model == "NN5_MAE" | model == "NN5_MSE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_MAE, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_mae_pre_all.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  filter(model == "LM_MAE" | model == "LM_MSE" 
         | model == "ELN_MAE" | model == "ELN_MSE"
         | model == "RF_MAE" | model == "RF_MSE"
         | model == "NN5_MAE" | model == "NN5_MSE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_MSE, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_mse_pre_all.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  filter(model == "LM_MAE" | model == "LM_MSE" 
         | model == "ELN_MAE" | model == "ELN_MSE"
         | model == "RF_MAE" | model == "RF_MSE"
         | model == "NN5_MAE" | model == "NN5_MSE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_RSquare, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_rsquare_pre_all.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")

###########################
## Plots for presentation

breaks <- levels(all_loss_df_averaged$model)
labels <- as.expression(breaks)
labels[[4]] <- bquote(bold(.(labels[[4]])))
labels[[6]] <- bquote(bold(.(labels[[6]])))

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  filter(model == "LM_MSE" 
         | model == "ELN_MAE"
         | model == "RF_MAE"
         | model == "NN5_MAE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_MAE, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_mae_pre.pdf")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  filter(model == "LM_MSE" 
         | model == "ELN_MAE"
         | model == "RF_MAE"
         | model == "NN5_MAE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_MSE, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_mse_pre.pdf")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  filter(model == "LM_MSE" 
         | model == "ELN_MAE"
         | model == "RF_MAE"
         | model == "NN5_MAE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_RSquare, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_rsquare_pre.pdf")

###################################################################################################################

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_RMSE, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_rmse.pdf")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  filter(model == "LM_MSE" 
         | model == "ELN_MAE"
         | model == "RF_MAE"
         | model == "NN5_MAE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_RSquare, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_rsquare.pdf")

###############################################################################################################
###############################################################################################################
## More proper graphs that are much more readable
## Achieve this by only showing the best neural network

breaks <- levels(all_loss_df_averaged$model)
labels <- as.expression(breaks)
labels[[4]] <- bquote(bold(.(labels[[4]])))
labels[[6]] <- bquote(bold(.(labels[[6]])))

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ## Filter out certain models
  filter(model == "LM_MSE"
         | model == "ELN_MAE"
         | model == "RF_MAE"
         | model == "NN5_MAE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_MSE, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_mse_small.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ## Filter out certain models
  filter(model == "LM_MSE"
         | model == "ELN_MAE"
         | model == "RF_MAE"
         | model == "NN5_MAE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_MAE, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_mae_small.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ## Filter out certain models
  filter(model == "LM_MSE"
         | model == "ELN_MAE"
         | model == "RF_MAE"
         | model == "NN5_MAE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_RSquare, fill = sample), stat = "identity", position = position_dodge()) +
  scale_x_discrete(label = labels, breaks = breaks) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_rsquare_small.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")

##############################################
## Focusing on only Neural Networks

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ## Filter out certain models
  filter(model == "NN1_MAE"
         | model == "NN2_MAE"
         | model == "NN3_MAE"
         | model == "NN4_MAE"
         | model == "NN5_MAE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_MSE, fill = sample), stat = "identity", position = position_dodge()) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_mse_small_nn.pdf")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ## Filter out certain models
  filter(model == "NN1_MAE"
         | model == "NN2_MAE"
         | model == "NN3_MAE"
         | model == "NN4_MAE"
         | model == "NN5_MAE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_MAE, fill = sample), stat = "identity", position = position_dodge()) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_mae_small_nn.pdf")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ## Filter out certain models
  filter(model == "NN1_MAE"
         | model == "NN2_MAE"
         | model == "NN3_MAE"
         | model == "NN4_MAE"
         | model == "NN5_MAE") %>%
  ggplot() +
  geom_bar(aes(x = model, y = test_RSquare, fill = sample), stat = "identity", position = position_dodge()) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_rsquare_small_nn.pdf")

## All Models

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ## Filter out certain models
  ggplot() +
  geom_bar(aes(x = model, y = test_MSE, fill = sample), stat = "identity", position = position_dodge()) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_mse.pdf")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ## Filter out certain models
  ggplot() +
  geom_bar(aes(x = model, y = test_MAE, fill = sample), stat = "identity", position = position_dodge()) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_mae.pdf")

all_loss_df_averaged %>%
  ungroup() %>%
  mutate(sample = as.factor(sample)) %>%
  ## Filter out certain models
  ggplot() +
  geom_bar(aes(x = model, y = test_RSquare, fill = sample), stat = "identity", position = position_dodge()) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_brewer(palette = "Paired") +
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave(filename = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_test_rsquare.pdf")
```

```{r variable_importance_plots}
# Variable Importance Plots

breaks <- levels(all_vi_df_averaged$variable)
labels <- as.expression(breaks)
labels[[1]] <- bquote(bold(.(labels[[1]])))
labels[[2]] <- bquote(bold(.(labels[[2]])))
labels[[3]] <- bquote(bold(.(labels[[3]])))
labels[[303]] <- bquote(bold(.(labels[[303]])))

## Plots for PRESENTATION

all_vi_df_averaged %>%
  filter(dgp_spec == "g1") %>%
  filter(model == "LM_MSE" 
         | model == "ELN_MAE"
         | model == "RF_MAE"
         | model == "NN5_MAE") %>%
  group_by(dgp_spec, model, variable, cross_corr, SV) %>%
  summarise(importance = mean(importance)) %>%
  ungroup() %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  top_n(10, importance) %>%
  ggplot() + 
  geom_tile(aes(x = variable, y = model, alpha = importance)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.position = "none") +
  # Facet
  facet_grid(rows = vars(cross_corr))
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_g1_vi_plot.pdf")

all_vi_df_averaged %>%
  filter(dgp_spec == "g2") %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  group_by(dgp_spec, model, sample, cross_corr, SV) %>%
  top_n(2, importance) %>%
  ggplot() + 
  geom_tile(aes(x = model, y = variable, alpha = importance)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.position = "none") +
  # Facet
  facet_grid(rows = vars(cross_corr), cols = vars(sample))
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_g2_vi_plot.pdf")

all_vi_df_averaged %>%
  filter(dgp_spec == "g3") %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  group_by(dgp_spec, model, sample, cross_corr, SV) %>%
  top_n(2, importance) %>%
  ggplot() + 
  geom_tile(aes(x = model, y = variable, alpha = importance)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.position = "none") +
  # Facet
  facet_grid(rows = vars(cross_corr), cols = vars(sample))
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_g3_vi_plot.pdf")

## Average variable importance over all samples

## Find the top x% of important varaibles, on average

top_variables <- all_vi_df_averaged %>%
  group_by(variable) %>%
  summarise(importance = mean(importance)) %>%
  arrange(desc(importance)) %>%
  top_n(30, importance)

top_variables <- as.character(top_variables$variable)

all_vi_df_averaged %>%
  filter(model == "LM_MSE" 
         | model == "ELN_MAE"
         | model == "RF_MAE"
         | model == "NN5_MAE") %>%
  filter(variable %in% top_variables) %>%
  group_by(dgp_spec, model, cross_corr, variable, SV) %>%
  summarise(importance = mean(importance)) %>%
  ungroup() %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() + 
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral") + 
  # Facet
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_ave_vi_plot_pre.pdf",
       width = 20 * a4_aspect_ratio, height = 20, units = "cm")

all_vi_df_averaged %>%
  filter(model == "NN1_MAE"
         | model == "NN2_MAE"
         | model == "NN3_MAE"
         | model == "NN4_MAE"
         | model == "NN5_MAE") %>%
  filter(variable %in% top_variables) %>%
  group_by(dgp_spec, model, cross_corr, variable, SV) %>%
  summarise(importance = mean(importance)) %>%
  ungroup() %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() + 
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral") + 
  # Facet
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_ave_vi_plot_pre_nn.pdf",
       width = 20 * a4_aspect_ratio, height = 20, units = "cm")

all_vi_df_averaged %>%
  filter(model == "RF_MAE"
         | model == "RF_MSE") %>%
  filter(variable %in% top_variables) %>%
  group_by(dgp_spec, model, cross_corr, variable, SV) %>%
  summarise(importance = mean(importance)) %>%
  ungroup() %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() + 
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral") + 
  # Facet
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_ave_vi_plot_pre_rf.pdf",
       width = 20 * a4_aspect_ratio, height = 20, units = "cm")

all_vi_df_averaged %>%
  filter(model == "ELN_MAE"
         | model == "ELN_MSE") %>%
  filter(variable %in% top_variables) %>%
  group_by(dgp_spec, model, cross_corr, variable, SV) %>%
  summarise(importance = mean(importance)) %>%
  ungroup() %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() + 
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral") + 
  # Facet
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))

all_vi_df_averaged %>%
  filter(variable %in% top_variables) %>%
  group_by(dgp_spec, model, cross_corr, variable, SV) %>%
  summarise(importance = mean(importance)) %>%
  ungroup() %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() + 
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral") + 
  # Facet
  facet_grid(rows = vars(cross_corr), cols = vars(dgp_spec))
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_ave_vi_plot.pdf",
       width = 20 * a4_aspect_ratio, height = 20, units = "cm")

```

```{r hyperparam_functions}
## Plotting hyperparameters of ELN across different training samples

# Function to extract ELN hyperparameter df from simulation results list

get_eln_hyper_df <- function(simulation_results_list, realization_no, dgp_spec, SV, cross_corr) {
  foreach(sample = 1:3, .combine = "rbind") %do% {
    rbind(
      cbind(realization_no = realization_no, sample = sample, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, model = "ELN_MSE",
            simulation_results_list[[realization_no]]$ELN_MSE[[sample]]$hyperparameters),
      cbind(realization_no = realization_no, sample = sample, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, model = "ELN_MAE",
            simulation_results_list[[realization_no]]$ELN_MAE[[sample]]$hyperparameters)
      )
  }
}

# Iterate this over all realizations

iterate_over_realization <- function(simulation_results_list, dgp_spec, SV, cross_corr) {
  foreach(realization_no = 1:10, .combine = "rbind") %do% {
    get_eln_hyper_df(simulation_results_list, realization_no = realization_no, dgp_spec, SV, cross_corr)
  }
}

eln_hyperparameters_df <- rbind(
  iterate_over_realization(g1_A1_nosv_0_results_all, "g1", 0, 0),
  iterate_over_realization(g2_A1_nosv_0_results_all, "g2", 0, 0),
  iterate_over_realization(g3_A1_nosv_0_results_all, "g3", 0, 0),
  
  iterate_over_realization(g1_A1_sv_0.01_results_all, "g1", 1, 0.01),
  iterate_over_realization(g2_A1_sv_0.01_results_all, "g2", 1, 0.01),
  iterate_over_realization(g3_A1_sv_0.01_results_all, "g3", 1, 0.01),
  
  iterate_over_realization(g1_A1_sv_0.1_results_all, "g1", 1, 0.1),
  iterate_over_realization(g2_A1_sv_0.1_results_all, "g2", 1, 0.1),
  iterate_over_realization(g3_A1_sv_0.1_results_all, "g3", 1, 0.1),
  
  iterate_over_realization(g1_A1_sv_1_results_all, "g1", 1, 1),
  iterate_over_realization(g2_A1_sv_1_results_all, "g2", 1, 1),
  iterate_over_realization(g3_A1_sv_1_results_all, "g3", 1, 1)
)

## Alpha value plot
eln_hyperparameters_df %>%
  mutate(group_id = group_indices(., realization_no, model, dgp_spec, SV, cross_corr)) %>%
  mutate(group_id = as.factor(group_id)) %>%
  ggplot() +
  geom_line(aes(x = sample, y = alpha, group = group_id, colour = group_id)) +
  scale_x_continuous(breaks = c(1, 2, 3)) +
  theme_bw() +
  theme(legend.position = "none")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/eln_alpha_plot.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")

## Lambda Value Plot
eln_hyperparameters_df %>%
  mutate(group_id = group_indices(., realization_no, model, dgp_spec, SV, cross_corr)) %>%
  mutate(group_id = as.factor(group_id)) %>%
  ggplot() +
  geom_line(aes(x = sample, y = lambda, group = group_id, colour = group_id)) +
  scale_x_continuous(breaks = c(1, 2, 3)) +
  theme_bw() +
  theme(legend.position = "none")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/eln_lambda_plot.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")
```

```{r hyperparam_plots}
## Plotting hyperparameters of randomforest across training samples

get_rf_hyper_df <- function(simulation_results_list, realization_no, dgp_spec, SV, cross_corr) {
  foreach(sample = 1:3, .combine = "rbind") %do% {
    rbind(
      cbind(realization_no = realization_no, sample = sample, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, model = "RF_MSE",
            simulation_results_list[[realization_no]]$RF_MSE[[sample]]$hyperparameters),
      cbind(realization_no = realization_no, sample = sample, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, model = "RF_MAE",
            simulation_results_list[[realization_no]]$RF_MAE[[sample]]$hyperparameters)
      )
  }
}

iterate_over_realization <- function(simulation_results_list, dgp_spec, SV, cross_corr) {
  foreach(realization_no = 1:10, .combine = "rbind") %do% {
    get_rf_hyper_df(simulation_results_list, realization_no = realization_no, dgp_spec, SV, cross_corr)
  }
}

rf_hyperparameters_df <- rbind(
  iterate_over_realization(g1_A1_nosv_0_results_all, "g1", 0, 0),
  iterate_over_realization(g2_A1_nosv_0_results_all, "g2", 0, 0),
  iterate_over_realization(g3_A1_nosv_0_results_all, "g3", 0, 0),
  
  iterate_over_realization(g1_A1_sv_0.01_results_all, "g1", 1, 0.01),
  iterate_over_realization(g2_A1_sv_0.01_results_all, "g2", 1, 0.01),
  iterate_over_realization(g3_A1_sv_0.01_results_all, "g3", 1, 0.01),
  
  iterate_over_realization(g1_A1_sv_0.1_results_all, "g1", 1, 0.1),
  iterate_over_realization(g2_A1_sv_0.1_results_all, "g2", 1, 0.1),
  iterate_over_realization(g3_A1_sv_0.1_results_all, "g3", 1, 0.1),
  
  iterate_over_realization(g1_A1_sv_1_results_all, "g1", 1, 1),
  iterate_over_realization(g2_A1_sv_1_results_all, "g2", 1, 1),
  iterate_over_realization(g3_A1_sv_1_results_all, "g3", 1, 1)
)

rf_hyperparameters_df %>%
  mutate(group_id = group_indices(., realization_no, model, dgp_spec, SV, cross_corr)) %>%
  mutate(group_id = as.factor(group_id)) %>%
  ggplot() +
  geom_line(aes(x = sample, y = mtry, group = group_id, colour = group_id)) +
  scale_x_continuous(breaks = c(1, 2, 3)) +
  theme_bw() +
  theme(legend.position = "none")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/rf_mtry_plot.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")

rf_hyperparameters_df %>%
  mutate(group_id = group_indices(., realization_no, model, dgp_spec, SV, cross_corr)) %>%
  mutate(group_id = as.factor(group_id)) %>%
  ggplot() +
  geom_line(aes(x = sample, y = nodesize, group = group_id, colour = group_id)) +
  scale_x_continuous(breaks = c(1, 2, 3)) +
  theme_bw() +
  theme(legend.position = "none")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/rf_nodesize_plot.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")
```

