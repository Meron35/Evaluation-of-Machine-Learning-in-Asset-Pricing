---
title: "Real Data"
author: "Ze Yu Zhong"
date: "22/07/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
################
##Load Libraries
################

library(tidyverse)
library(keras)
library(ggplot2)
library(forecast)
library(rlist)
library(Metrics)
library(ranger)
library(caret)
library(readr)
library(zoo)
library(readxl)

#Parallel Computing
library(foreach)
library(doFuture)
#Registering
registerDoFuture()
plan(multisession)

set.seed(27935248)
```

```{r}
# Load RAW data
# This is about ~ 3GB in size in total
datashare_RAW <- read_csv("data/datashare/datashare.csv",
                          # Always make sure to force col_types so that read_csv doesn't assume weird stuff
                          col_types = cols(.default = "d"))

datashare <- datashare_RAW %>%
  mutate(Time = as.yearmon(as.character(DATE), "%Y%m%d")) #%>%
  #select(-DATE)

# Load RAW Welch Goyal Data
# Note that Gu et al only used:
# Dividend price ratio dp, earnings price ratio ep, book to market ratio bm,
# net equity expansion ntis, Treasury bill rate tbl, term spread tms,
# Default spread dfy, stock variance svar
PredictorData2017_RAW <- read_excel("data/factors/PredictorData2017.xlsx", 
                                    na = "NaN")

PredictorData2017 <- PredictorData2017_RAW %>%
  mutate(Time = as.yearmon(as.character(yyyymm), "%Y%m")) %>%
  select(-yyyymm) %>%
  # Dividend price ratio is the difference between the log of dividends and the log of prices.
  mutate(dp = abs(log(D12) - log(Index))) %>%
  # earnings price ratio is the difference between the log of earnings and the log of prices.
  mutate(ep = abs(log(E12) - log(Index))) %>%
  # Term Spread is the difference between long term yield on gov bonds and treasury bills
  mutate(tms = lty - tbl) %>%
  # Default spread is the difference betwen difference between BAA and AAA-rated corporate bond yields
  mutate(dfy = abs(BAA - AAA)) %>%
  # Rename b/m to bm
  rename(bm = `b/m`)

# Subset so that we have the predictors we actually care about
macro_predictors <- PredictorData2017 %>%
  select(Time, dp, ep, bm, ntis, tbl, tms, dfy, svar)
  

#Summary Statistics

length(unique(datashare$permno))
# There are 29892 unique stocks to begin with
# There are 94 lagged characteristics/factors

# It seems as though that data is only fully available for some stocks in the dataset
# Absolutely no clue how Gu et al dealt with missing data issues
df_10006 <- datashare %>%
  filter(permno == 10006)
```
