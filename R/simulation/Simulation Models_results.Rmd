---
title: "Simulation Model Results"
author: "Ze Yu Zhong"
date: "21/07/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
################
##Load Libraries
################

library(tidyverse)
library(keras)
library(quantreg)
library(ggplot2)
library(forecast)
library(rlist)
library(Metrics)
library(ranger)
library(caret)
library(forcats)
library(xtable)
library(randomForestSRC)
library(kableExtra)
library(patchwork)

#Parallel Computing
library(foreach)
library(doFuture)

set.seed(27935248)
```

```{r load_final_results}
## Chunk to load final results list (just load this to avoid bothering with combining different results list)

# g1_A1_nosv_0_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g1_A1_nosv_0_results_all.RDS")
# g2_A1_nosv_0_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g2_A1_nosv_0_results_all.RDS")
# g3_A1_nosv_0_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g3_A1_nosv_0_results_all.RDS")

g1_A1_sv_0.01_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g1_A1_sv_0.01_results_all.RDS")
g2_A1_sv_0.01_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g2_A1_sv_0.01_results_all.RDS")
g3_A1_sv_0.01_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g3_A1_sv_0.01_results_all.RDS")

g1_A1_sv_0.1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g1_A1_sv_0.1_results_all.RDS")
g2_A1_sv_0.1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g2_A1_sv_0.1_results_all.RDS")
g3_A1_sv_0.1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g3_A1_sv_0.1_results_all.RDS")

g1_A1_sv_1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g1_A1_sv_1_results_all.RDS")
g2_A1_sv_1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g2_A1_sv_1_results_all.RDS")
g3_A1_sv_1_results_all <- readRDS("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/R/Model_results/g3_A1_sv_1_results_all.RDS")
```

```{r performance_functions}
## For a given simulation results list, collect all the loss dataframes into a big, tidy DF for a SINGLE realization

gen_tidy_loss_df <- function(simulation_results_list, realization_no, dgp_spec, SV, cross_corr) {
  df <- foreach(sample = (1:3), .combine = "rbind") %do% {
    rbind(
      cbind(model = "LM_MSE", sample = sample, simulation_results_list[[realization_no]]$LM_MSE[[sample]]$loss_stats),
      cbind(model = "LM_MAE", sample = sample, simulation_results_list[[realization_no]]$LM_MAE[[sample]]$loss_stats),
      ################################################################################################
      cbind(model = "ELN_MSE", sample = sample, simulation_results_list[[realization_no]]$ELN_MSE[[sample]]$loss_stats),
      cbind(model = "ELN_MAE", sample = sample, simulation_results_list[[realization_no]]$ELN_MAE[[sample]]$loss_stats),
      ################################################################################################
      cbind(model = "RF_MSE", sample = sample, simulation_results_list[[realization_no]]$RF_MSE[[sample]]$loss_stats),
      cbind(model = "RF_MAE", sample = sample, simulation_results_list[[realization_no]]$RF_MAE[[sample]]$loss_stats),
      ################################################################################################
      cbind(model = "NN1_MSE", sample = sample, simulation_results_list[[realization_no]]$NN1_MSE[[sample]]$loss_stats),
      cbind(model = "NN1_MAE", sample = sample, simulation_results_list[[realization_no]]$NN1_MAE[[sample]]$loss_stats),

      cbind(model = "NN2_MSE", sample = sample, simulation_results_list[[realization_no]]$NN2_MSE[[sample]]$loss_stats),
      cbind(model = "NN2_MAE", sample = sample, simulation_results_list[[realization_no]]$NN2_MAE[[sample]]$loss_stats),

      cbind(model = "NN3_MSE", sample = sample, simulation_results_list[[realization_no]]$NN3_MSE[[sample]]$loss_stats),
      cbind(model = "NN3_MAE", sample = sample, simulation_results_list[[realization_no]]$NN3_MAE[[sample]]$loss_stats),

      cbind(model = "NN4_MSE", sample = sample, simulation_results_list[[realization_no]]$NN4_MSE[[sample]]$loss_stats),
      cbind(model = "NN4_MAE", sample = sample, simulation_results_list[[realization_no]]$NN4_MAE[[sample]]$loss_stats),

      cbind(model = "NN5_MSE", sample = sample, simulation_results_list[[realization_no]]$NN5_MSE[[sample]]$loss_stats),
      cbind(model = "NN5_MAE", sample = sample, simulation_results_list[[realization_no]]$NN5_MAE[[sample]]$loss_stats),
      #################################################################################################
      cbind(model = "LSTM_MSE", sample = sample, simulation_results_list[[realization_no]]$LSTM_MSE[[sample]]$loss_stats),
      cbind(model = "LSTM_MAE", sample = sample, simulation_results_list[[realization_no]]$LSTM_MAE[[sample]]$loss_stats),
      #################################################################################################
      cbind(model = "FFORMA_MSE", sample = sample, simulation_results_list[[realization_no]]$FFORMA_MSE[[sample]]$loss_stats),
      cbind(model = "FFORMA_MAE", sample = sample, simulation_results_list[[realization_no]]$FFORMA_MAE[[sample]]$loss_stats),
      #################################################################################################
      cbind(model = "DeepAR", sample = sample, simulation_results_list[[realization_no]]$DeepAR[[sample]]$loss_stats)
    )
  }
  cbind(realization_no = realization_no, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, df)
}

# Function to iterate over all realizations

all_realize_loss_df <- function(simulation_results_list, dgp_spec, SV, cross_corr) {
  foreach(realization_no = (1:5), .combine = "rbind") %do% {
    gen_tidy_loss_df(simulation_results_list, realization_no, dgp_spec, SV, cross_corr)
  }
}

all_loss_df <- rbind(
  # all_realize_loss_df(g1_A1_nosv_0_results_all, dgp_spec = "g1", SV = 0, cross_corr = 0),
  # all_realize_loss_df(g2_A1_nosv_0_results_all, dgp_spec = "g2", SV = 0, cross_corr = 0),
  # all_realize_loss_df(g3_A1_nosv_0_results_all, dgp_spec = "g3", SV = 0, cross_corr = 0),
  
  all_realize_loss_df(g1_A1_sv_0.01_results_all, dgp_spec = "g1", SV = 1, cross_corr = 0.01),
  all_realize_loss_df(g2_A1_sv_0.01_results_all, dgp_spec = "g2", SV = 1, cross_corr = 0.01),
  all_realize_loss_df(g3_A1_sv_0.01_results_all, dgp_spec = "g3", SV = 1, cross_corr = 0.01),
  
  all_realize_loss_df(g1_A1_sv_0.1_results_all, dgp_spec = "g1", SV = 1, cross_corr = 0.1),
  all_realize_loss_df(g2_A1_sv_0.1_results_all, dgp_spec = "g2", SV = 1, cross_corr = 0.1),
  all_realize_loss_df(g3_A1_sv_0.1_results_all, dgp_spec = "g3", SV = 1, cross_corr = 0.1),
  
  all_realize_loss_df(g1_A1_sv_1_results_all, dgp_spec = "g1", SV = 1, cross_corr = 1),
  all_realize_loss_df(g2_A1_sv_1_results_all, dgp_spec = "g2", SV = 1, cross_corr = 1),
  all_realize_loss_df(g3_A1_sv_1_results_all, dgp_spec = "g3", SV = 1, cross_corr = 1)
)

all_loss_df_averaged <- all_loss_df %>%
  data.frame() %>%
  group_by(model, dgp_spec, sample, SV, cross_corr) %>%
  summarise(validation_MAE = mean(validation_MAE), validation_MSE = mean(validation_MSE), 
            validation_RMSE = mean(validation_RMSE), validation_RSquare = mean(validation_RSquare),
              
            test_MAE = mean(test_MAE), test_MSE = mean(test_MSE), 
            test_RMSE = mean(test_RMSE), test_RSquare = mean(test_RSquare)
            )

## Save to csv

write.csv(all_loss_df_averaged, file = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_loss_averaged.csv")
write.csv(all_loss_df, file = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_loss.csv")

########
## Take the above and average over all training/test samples to make cleaner graphs/tables

all_loss_df_averaged_sam <- all_loss_df_averaged %>%
  group_by(model, dgp_spec, SV, cross_corr) %>%
  summarise(validation_MAE = mean(validation_MAE), validation_MSE = mean(validation_MSE), 
            validation_RMSE = mean(validation_RMSE), validation_RSquare = mean(validation_RSquare),
              
            test_MAE = mean(test_MAE), test_MSE = mean(test_MSE), 
            test_RMSE = mean(test_RMSE), test_RSquare = mean(test_RSquare)
            ) %>%
  ## Create a new column for each loss metric averaged over all specifications for ordering purposes later
  group_by(model, cross_corr) %>%
  mutate(validation_MAE_ave = mean(validation_MAE), validation_MSE_ave = mean(validation_MSE), 
            validation_RMSE_ave = mean(validation_RMSE), validation_RSquare_ave = mean(validation_RSquare),
              
            test_MAE_ave = mean(test_MAE), test_MSE_ave = mean(test_MSE), 
            test_RMSE_ave = mean(test_RMSE), test_RSquare_ave = mean(test_RSquare)
            )

write.csv(all_loss_df_averaged_sam, file = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation_loss_averaged_sam.csv")

#############################################################################
# Function to collate variable importance

normalize_variable_importance <- function(variable_importance_df) {
  variable_importance_df %>%
    # Add a very very tiny value so that division by zero does not occur
    mutate(importance = importance + 1e-100) %>%
    mutate(importance = importance + abs(min(importance))) %>%
    mutate(importance = importance/sum(importance))
}

gen_tidy_vi <- function(simulation_results_list, realization_no, dgp_spec, SV, cross_corr) {
  df <- foreach(sample = 1:3, .combine = "rbind") %do% {
    rbind(
      cbind(model = "LM_MSE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$LM_MSE[[sample]]$variable_importance)),
      cbind(model = "LM_MAE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$LM_MAE[[sample]]$variable_importance)),
      
      ################################################################################################
      
      cbind(model = "ELN_MSE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$ELN_MSE[[sample]]$variable_importance)),
      cbind(model = "ELN_MAE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$ELN_MAE[[sample]]$variable_importance)),
      
      ################################################################################################
      
      cbind(model = "RF_MSE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$RF_MSE[[sample]]$variable_importance)),
      cbind(model = "RF_MAE", sample = sample, 
            normalize_variable_importance(simulation_results_list[[realization_no]]$RF_MAE[[sample]]$variable_importance)),
      
      ################################################################################################
      
      cbind(model = "NN1_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN1_MSE[[sample]]$variable_importance)),
      cbind(model = "NN1_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN1_MAE[[sample]]$variable_importance)),

      cbind(model = "NN2_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN2_MSE[[sample]]$variable_importance)),
      cbind(model = "NN2_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN2_MAE[[sample]]$variable_importance)),

      cbind(model = "NN3_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN3_MSE[[sample]]$variable_importance)),
      cbind(model = "NN3_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN3_MAE[[sample]]$variable_importance)),

      cbind(model = "NN4_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN4_MSE[[sample]]$variable_importance)),
      cbind(model = "NN4_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN4_MAE[[sample]]$variable_importance)),

      cbind(model = "NN5_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN5_MSE[[sample]]$variable_importance)),
      cbind(model = "NN5_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$NN5_MAE[[sample]]$variable_importance)),
      
      ################################################################################################
      
      cbind(model = "LSTM_MSE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$LSTM_MSE[[sample]]$variable_importance)),
      
      cbind(model = "LSTM_MAE", sample = sample,
            normalize_variable_importance(simulation_results_list[[realization_no]]$LSTM_MAE[[sample]]$variable_importance))
    )
  }
  cbind(realization_no = realization_no, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, df)
}

# Iterate over all realizations

all_realize_vi <- function(simulation_results_list, dgp_spec, SV, cross_corr) {
  foreach(realization_no = (1:5), .combine = "rbind") %do% {
    gen_tidy_vi(simulation_results_list, realization_no, dgp_spec, SV, cross_corr)
  }
}

all_vi_df <- rbind(
  # all_realize_vi(g1_A1_nosv_0_results_all, dgp_spec = "g1", SV = 0, cross_corr = 0),
  # all_realize_vi(g2_A1_nosv_0_results_all, dgp_spec = "g2", SV = 0, cross_corr = 0),
  # all_realize_vi(g3_A1_nosv_0_results_all, dgp_spec = "g3", SV = 0, cross_corr = 0),
  
  all_realize_vi(g1_A1_sv_0.01_results_all, dgp_spec = "g1", SV = 1, cross_corr = 0.01),
  all_realize_vi(g2_A1_sv_0.01_results_all, dgp_spec = "g2", SV = 1, cross_corr = 0.01),
  all_realize_vi(g3_A1_sv_0.01_results_all, dgp_spec = "g3", SV = 1, cross_corr = 0.01),
  
  all_realize_vi(g1_A1_sv_0.1_results_all, dgp_spec = "g1", SV = 1, cross_corr = 0.1),
  all_realize_vi(g2_A1_sv_0.1_results_all, dgp_spec = "g2", SV = 1, cross_corr = 0.1),
  all_realize_vi(g3_A1_sv_0.1_results_all, dgp_spec = "g3", SV = 1, cross_corr = 0.1),
  
  all_realize_vi(g1_A1_sv_1_results_all, dgp_spec = "g1", SV = 1, cross_corr = 1),
  all_realize_vi(g2_A1_sv_1_results_all, dgp_spec = "g2", SV = 1, cross_corr = 1),
  all_realize_vi(g3_A1_sv_1_results_all, dgp_spec = "g3", SV = 1, cross_corr = 1)
)

all_vi_df_averaged <- all_vi_df %>%
  group_by(model, dgp_spec, sample, SV, cross_corr, variable) %>%
  summarise(importance = mean(importance))
```

```{r tables}
#################################
## COMPREHENSIVE TABLES (SHOVE IN APPENDIX)
#################################
## Test MAE Comprehensive
model_sam <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(model)

cross_corr_sam <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(cross_corr)

##

g1_sam_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  dplyr::select(dgp_spec, cross_corr, test_MAE) %>%
  rename(`Test MAE` = test_MAE) %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(-dgp_spec, -cross_corr)

g2_sam_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  dplyr::select(dgp_spec, cross_corr, test_MAE) %>%
  rename(`Test MAE` = test_MAE) %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g2") %>%
  dplyr::select(-dgp_spec, -cross_corr)

g3_sam_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  dplyr::select(dgp_spec, cross_corr, test_MAE) %>%
  rename(`Test MAE` = test_MAE) %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g3") %>%
  dplyr::select(-dgp_spec, -cross_corr)

#######

g1_sam_mse <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  dplyr::select(dgp_spec, cross_corr, test_MSE) %>%
  rename(`Test MSE` = test_MSE) %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(-dgp_spec, -cross_corr)

g2_sam_mse <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  dplyr::select(dgp_spec, cross_corr, test_MSE) %>%
  rename(`Test MSE` = test_MSE) %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g2") %>%
  dplyr::select(-dgp_spec, -cross_corr)

g3_sam_mse <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  dplyr::select(dgp_spec, cross_corr, test_MSE) %>%
  rename(`Test MSE` = test_MSE) %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g3") %>%
  dplyr::select(-dgp_spec, -cross_corr)

#########################

g1_sam_r2 <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  dplyr::select(dgp_spec, cross_corr, test_RSquare) %>%
  rename(`Test $R^2$` = test_RSquare) %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(-dgp_spec, -cross_corr)

g2_sam_r2 <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  dplyr::select(dgp_spec, cross_corr, test_RSquare) %>%
  rename(`Test $R^2$` = test_RSquare) %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g2") %>%
  dplyr::select(-dgp_spec, -cross_corr)

g3_sam_r2 <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  dplyr::select(dgp_spec, cross_corr, test_RSquare) %>%
  rename(`Test $R^2$` = test_RSquare) %>%
  filter(cross_corr != 0) %>%
  filter(dgp_spec == "g3") %>%
  dplyr::select(-dgp_spec, -cross_corr)

model_sam <- model_sam %>%
  mutate(model = str_replace(model, "_", "."))

cross_corr_sam <- cross_corr_sam %>%
  rename(Corr = cross_corr)

test_loss_latex <- cbind(model_sam, cross_corr_sam, 
                         g1_sam_mae, g1_sam_mse, g1_sam_r2, 
                         g2_sam_mae, g2_sam_mse, g2_sam_r2, 
                         g3_sam_mae, g3_sam_mse, g3_sam_r2) %>%
  kable(align = "c", format = "latex", booktabs = T, 
        escape = F, longtable = T,
        caption = "Simulation Study Loss Statistics") %>%
  add_header_above(c(" " = 1, " " = 1, "g1" = 3, "g2" = 3, "g3" = 3)) %>%
  kable_styling(font_size = 6,
                latex_options = c("repeat_header"),
                repeat_header_text = "") %>%
  collapse_rows(columns = c(1:2), valign = "middle")

test_loss_latex %>%
  cat(file = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/test_loss_latex.tex")
  
```

```{r small_tables}
## Different methods are better on different specifications:
## Solution: make an "average" loss column across all specifications and order them by this metric

ordering_0.01_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 0.01) %>%
  arrange(-desc(test_MAE_ave)) %>%
  dplyr::select(model) %>%
  unique()

ordering_1_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 1) %>%
  arrange(-desc(test_MAE_ave)) %>%
  dplyr::select(model) %>%
  unique()

## Doesn't seem to be an easy way to choose which "sub method" is the best, just doing it manually from viewing above
ordering_0.01 <- c("ELN_MAE", "RF_MAE", "NN2_MAE", "NN1_MAE", "NN3_MAE")

ordering_1 <- c("ELN_MSE", "RF_MAE", "NN5_MAE", "NN4_MSE", "NN3_MAE")

g1_0.01_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 0.01) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MAE) %>%
  rename(g1 = test_MAE) %>%
  ## Filtering out so that we only have the quantile methods
  filter(model %in% ordering_0.01) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g2_0.01_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 0.01) %>%
  filter(dgp_spec == "g2") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MAE) %>%
  rename(g2 = test_MAE) %>%
  ## Filtering out so that we only have the quantile methods %>%
  filter(model %in% ordering_0.01) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g3_0.01_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 0.01) %>%
  filter(dgp_spec == "g3") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MAE) %>%
  rename(g3 = test_MAE) %>%
  filter(model %in% ordering_0.01) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

################
g1_1_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 1) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MAE) %>%
  rename(g1 = test_MAE) %>%
  ## Filtering out so that we only have the quantile methods
  filter(model %in% ordering_1) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g2_1_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 1) %>%
  filter(dgp_spec == "g2") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MAE) %>%
  rename(g2 = test_MAE) %>%
  ## Filtering out so that we only have the quantile methods %>%
  filter(model %in% ordering_1) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g3_1_mae <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 1) %>%
  filter(dgp_spec == "g3") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MAE) %>%
  rename(g3 = test_MAE) %>%
  filter(model %in% ordering_1) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)
###############################################################################################
g1_0.01_mse <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 0.01) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MSE) %>%
  rename(g1 = test_MSE) %>%
  ## Filtering out so that we only have the quantile methods
  filter(model %in% ordering_0.01) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g2_0.01_mse <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 0.01) %>%
  filter(dgp_spec == "g2") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MSE) %>%
  rename(g2 = test_MSE) %>%
  ## Filtering out so that we only have the quantile methods %>%
  filter(model %in% ordering_0.01) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g3_0.01_mse <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 0.01) %>%
  filter(dgp_spec == "g3") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MSE) %>%
  rename(g3 = test_MSE) %>%
  filter(model %in% ordering_0.01) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)
################
g1_1_mse <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 1) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MSE) %>%
  rename(g1 = test_MSE) %>%
  ## Filtering out so that we only have the quantile methods
  filter(model %in% ordering_1) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g2_1_mse <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 1) %>%
  filter(dgp_spec == "g2") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MSE) %>%
  rename(g2 = test_MSE) %>%
  ## Filtering out so that we only have the quantile methods %>%
  filter(model %in% ordering_1) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g3_1_mse <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 1) %>%
  filter(dgp_spec == "g3") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_MSE) %>%
  rename(g3 = test_MSE) %>%
  filter(model %in% ordering_1) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)
################################################################
g1_0.01_r2 <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 0.01) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_RSquare) %>%
  rename(g1 = test_RSquare) %>%
  ## Filtering out so that we only have the quantile methods
  filter(model %in% ordering_0.01) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g2_0.01_r2 <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 0.01) %>%
  filter(dgp_spec == "g2") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_RSquare) %>%
  rename(g2 = test_RSquare) %>%
  ## Filtering out so that we only have the quantile methods %>%
  filter(model %in% ordering_0.01) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g3_0.01_r2 <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 0.01) %>%
  filter(dgp_spec == "g3") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_RSquare) %>%
  rename(g3 = test_RSquare) %>%
  filter(model %in% ordering_0.01) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)
################
g1_1_r2 <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 1) %>%
  filter(dgp_spec == "g1") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_RSquare) %>%
  rename(g1 = test_RSquare) %>%
  ## Filtering out so that we only have the quantile methods
  filter(model %in% ordering_1) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g2_1_r2 <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 1) %>%
  filter(dgp_spec == "g2") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_RSquare) %>%
  rename(g2 = test_RSquare) %>%
  ## Filtering out so that we only have the quantile methods %>%
  filter(model %in% ordering_1) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

g3_1_r2 <- all_loss_df_averaged_sam %>%
  ungroup() %>%
  filter(cross_corr == 1) %>%
  filter(dgp_spec == "g3") %>%
  dplyr::select(model, dgp_spec, cross_corr, test_RSquare) %>%
  rename(g3 = test_RSquare) %>%
  filter(model %in% ordering_1) %>%
  dplyr::select(-model, -dgp_spec, -cross_corr)

cross_corr_sam <- data.frame(Corr = c(rep(0.01, 5), rep(1, 5))) %>%
  mutate(Corr = cell_spec(Corr, angle = 90, format = "latex"))

model_sam <- data.frame(model = c(ordering_0.01, ordering_1)) %>%
  mutate(model = str_replace(model, "_", "."))

test_small_latex <- cbind(cross_corr_sam, model = model_sam,
                          rbind(
                            cbind(g1_0.01_mae, g2_0.01_mae, g3_0.01_mae, g1_0.01_mse, g2_0.01_mse, g3_0.01_mse),
                            cbind(g1_1_mae, g2_1_mae, g3_1_mae, g1_1_mse, g2_1_mse, g3_1_mse)
                          )) %>%
  kable(align = "c", format = "latex", booktabs = T, 
        escape = F, longtable = T,
        caption = "Top Models in Simulation Study") %>%
  add_header_above(c(" " = 1, " " = 1, "Test MAE" = 3, "Test MSE" = 3)) %>%
  kable_styling(font_size = 6,
                latex_options = c("repeat_header"),
                repeat_header_text = "") %>%
  collapse_rows(columns = c(1:2), valign = "middle", latex_hline = "major")

test_small_latex %>%
  cat(file = "~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/test_small_latex.tex")
```

```{r variable_importance_plots}
a4_aspect_ratio <- 1.3
# Variable Importance Plots

breaks <- levels(all_vi_df_averaged$variable)

## Bolding the true predictors for each specification
g1_labels <- as.expression(breaks)
g1_labels[[1]] <- bquote(bold(.(g1_labels[[1]])))
g1_labels[[2]] <- bquote(bold(.(g1_labels[[2]])))
g1_labels[[303]] <- bquote(bold(.(g1_labels[[303]])))

g2_labels <- as.expression(breaks)
g2_labels[[1]] <- bquote(bold(.(g2_labels[[1]])))
g2_labels[[2]] <- bquote(bold(.(g2_labels[[2]])))
g2_labels[[303]] <- bquote(bold(.(g2_labels[[303]])))

g3_labels <- as.expression(breaks)
g3_labels[[1]] <- bquote(bold(.(g3_labels[[1]])))
g3_labels[[2]] <- bquote(bold(.(g3_labels[[2]])))
g3_labels[[3]] <- bquote(bold(.(g3_labels[[3]])))

## Plots for PRESENTATION
## Average over all samples
all_vi_df_averaged_sam <- all_vi_df_averaged %>%
  group_by(dgp_spec, model, variable, cross_corr) %>%
  summarise(importance = mean(importance)) %>%
  ungroup()

## Find the most important variables across all variables over all methods
important_variables_g1 <- all_vi_df_averaged_sam %>%
  filter(dgp_spec == "g1") %>%
  group_by(variable) %>%
  summarise(importance = mean(importance)) %>%
  arrange(desc(importance)) %>%
  ## Select the top 10
  head(10) %>%
  dplyr::select(variable) %>%
  pull() %>%
  as.vector()
  
important_variables_g2 <- all_vi_df_averaged_sam %>%
  filter(dgp_spec == "g2") %>%
  group_by(variable) %>%
  summarise(importance = mean(importance)) %>%
  arrange(desc(importance)) %>%
  ## Select the top 10
  head(10) %>%
  dplyr::select(variable) %>%
  pull() %>%
  as.vector()

important_variables_g3 <- all_vi_df_averaged_sam %>%
  filter(dgp_spec == "g3") %>%
  group_by(variable) %>%
  summarise(importance = mean(importance)) %>%
  arrange(desc(importance)) %>%
  ## Select the top 10
  head(10) %>%
  dplyr::select(variable) %>%
  pull() %>%
  as.vector()

top_model <- c("LM_MSE", "ELN_MAE", "RF_MAE", "NN5_MAE", "LSTM_MAE", "FFORMA_MSE")

g1_vi_plot <- all_vi_df_averaged_sam %>%
  filter(dgp_spec == "g1") %>%
  filter(model %in% top_model) %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  filter(variable %in% important_variables_g2) %>%
  ggplot() +
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = g1_labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.y = element_text(size = rel(0.9))) +
  theme(axis.text.x = element_text(size = rel(0.9), angle = 90, hjust = 1)) +
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral",
                       limits = c(min(all_vi_df_averaged_sam$importance), 
                                  max(all_vi_df_averaged_sam$importance))
                       ) +
  ggtitle("g1") + 
  facet_grid(rows = vars(cross_corr))
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g1_vi.pdf",
       width = 7 * a4_aspect_ratio, height = 7, units = "cm")

g2_vi_plot <- all_vi_df_averaged_sam %>%
  filter(dgp_spec == "g2") %>%
  filter(model %in% top_model) %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  filter(variable %in% important_variables_g2) %>%
  ggplot() +
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = g2_labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(size = rel(0.9), angle = 90, hjust = 1)) +
  theme(legend.position = "right") +
  theme(axis.text.y = element_blank()) + 
  ylab("") + 
  scale_y_discrete(breaks = NULL) +
  scale_fill_distiller(palette = "Spectral",
                       limits = c(min(all_vi_df_averaged_sam$importance), 
                                  max(all_vi_df_averaged_sam$importance))
                       ) + 
  ggtitle("g2") + 
  facet_grid(rows = vars(cross_corr))
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g2_vi.pdf",
       width = 7 * a4_aspect_ratio, height = 7, units = "cm")

g3_vi_plot <- all_vi_df_averaged_sam %>%
  filter(dgp_spec == "g3") %>%
  filter(model %in% top_model) %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  filter(variable %in% important_variables_g3) %>%
  ggplot() +
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = g3_labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(size = rel(0.9), angle = 90, hjust = 1)) +
  theme(legend.position = "right") +
  theme(axis.text.y = element_blank()) + 
  ylab("") + 
  scale_y_discrete(breaks = NULL) +
  scale_fill_distiller(palette = "Spectral",
                       limits = c(min(all_vi_df_averaged_sam$importance), 
                                  max(all_vi_df_averaged_sam$importance))
                       ) +
  ggtitle("g3") + 
  facet_grid(rows = vars(cross_corr))
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g3_vi.pdf",
       width = 7 * a4_aspect_ratio, height = 7, units = "cm")

g1_vi_plot + g2_vi_plot + g3_vi_plot +
  plot_layout(guides = 'collect')
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_all_g_vi.pdf",
       width = 18, height = 9, units = "cm")
```

```{r}
# Variable Importance Plots for Random Forests

breaks <- levels(all_vi_df_averaged$variable)

## Bolding the true predictors for each specification
g1_labels <- as.expression(breaks)
g1_labels[[1]] <- bquote(bold(.(g1_labels[[1]])))
g1_labels[[2]] <- bquote(bold(.(g1_labels[[2]])))
g1_labels[[303]] <- bquote(bold(.(g1_labels[[303]])))

g2_labels <- as.expression(breaks)
g2_labels[[1]] <- bquote(bold(.(g2_labels[[1]])))
g2_labels[[2]] <- bquote(bold(.(g2_labels[[2]])))
g2_labels[[303]] <- bquote(bold(.(g2_labels[[303]])))

g3_labels <- as.expression(breaks)
g3_labels[[1]] <- bquote(bold(.(g3_labels[[1]])))
g3_labels[[2]] <- bquote(bold(.(g3_labels[[2]])))
g3_labels[[3]] <- bquote(bold(.(g3_labels[[3]])))

## Function to loop over and extract all vimps from results list objects

vimp_realisation <- function(results_list, realisation) {
  vimp_tidy <- foreach(set = 1:3, .combine = "rbind") %do% {
    bc <- rbind(cbind(sample = set, model = "RF_MSE", type = "bc",
                      data.frame(variable = names(results_list[[realisation]]$RF_MSE[[set]]$vimp$breiman_cutler),
                                 importance = results_list[[realisation]]$RF_MSE[[set]]$vimp$breiman_cutler)), 
                cbind(sample = set, model = "RF_MAE", type = "bc",
                      data.frame(variable = names(results_list[[realisation]]$RF_MAE[[set]]$vimp$breiman_cutler),
                                 importance = results_list[[realisation]]$RF_MAE[[set]]$vimp$breiman_cutler))
                )
    
    ik <- rbind(cbind(sample = set, model = "RF_MSE", type = "ik", 
                      data.frame(variable = names(results_list[[realisation]]$RF_MSE[[set]]$vimp$ishwaran_kogalur),
                                 importance = results_list[[realisation]]$RF_MSE[[set]]$vimp$ishwaran_kogalur)),
                cbind(sample = set, model = "RF_MAE", type = "ik", 
                      data.frame(variable = names(results_list[[realisation]]$RF_MAE[[set]]$vimp$ishwaran_kogalur),
                                 importance = results_list[[realisation]]$RF_MAE[[set]]$vimp$ishwaran_kogalur))
    )
    rbind(bc, ik)
  }
  row.names(vimp_tidy) <- NULL
  vimp_tidy
}

## Function to iterate the above function over all realisations

vimp_iterate <- function(results_list) {
  vimp_tidy <- foreach(i = 1:10, .combine = "rbind") %do% {
    cbind(realization_no = i, vimp_realisation(results_list, realisation = i))
  }
}

all_vimp_tidy_df <- rbind(
  cbind(dgp_spec = "g1", cross_corr = 0.01, g1_A1_sv_0.01_results_all %>% vimp_iterate),
  cbind(dgp_spec = "g2", cross_corr = 0.01, g2_A1_sv_0.01_results_all %>% vimp_iterate),
  cbind(dgp_spec = "g3", cross_corr = 0.01, g3_A1_sv_0.01_results_all %>% vimp_iterate),
  
  cbind(dgp_spec = "g1", cross_corr = 0.1, g1_A1_sv_0.1_results_all %>% vimp_iterate),
  cbind(dgp_spec = "g2", cross_corr = 0.1, g2_A1_sv_0.1_results_all %>% vimp_iterate),
  cbind(dgp_spec = "g3", cross_corr = 0.1, g3_A1_sv_0.1_results_all %>% vimp_iterate),
  
  cbind(dgp_spec = "g1", cross_corr = 1, g1_A1_sv_1_results_all %>% vimp_iterate),
  cbind(dgp_spec = "g2", cross_corr = 1, g2_A1_sv_1_results_all %>% vimp_iterate),
  cbind(dgp_spec = "g3", cross_corr = 1, g3_A1_sv_1_results_all %>% vimp_iterate)
)

## Average everything over all samples and realizations
all_vimp_tidy_df_sam <- all_vimp_tidy_df %>%
  group_by(dgp_spec, cross_corr, model, variable, type) %>%
  summarise(importance = mean(importance)) %>%
  ungroup()

## Find the top variables for each specification
important_vimps_g1 <- all_vimp_tidy_df_sam %>%
  filter(dgp_spec == "g1") %>%
  group_by(dgp_spec, variable) %>%
  summarise(importance = mean(importance)) %>%
  ungroup() %>%
  arrange(desc(importance)) %>%
  head(10) %>%
  dplyr::select(variable) %>%
  pull() %>%
  as.vector()

important_vimps_g2 <- all_vimp_tidy_df_sam %>%
  filter(dgp_spec == "g2") %>%
  group_by(dgp_spec, variable) %>%
  summarise(importance = mean(importance)) %>%
  ungroup() %>%
  arrange(desc(importance)) %>%
  head(10) %>%
  dplyr::select(variable) %>%
  pull() %>%
  as.vector()

important_vimps_g3 <- all_vimp_tidy_df_sam %>%
  filter(dgp_spec == "g3") %>%
  group_by(dgp_spec, variable) %>%
  summarise(importance = mean(importance)) %>%
  ungroup() %>%
  arrange(desc(importance)) %>%
  head(10) %>%
  dplyr::select(variable) %>%
  pull() %>%
  as.vector()

## Begin plotting
## Notes on these plots
## They don't look incredibly consistent at first, but realise that these are the raw vimps which have no been normalised
## If anything, our metric is more lenient

## BC Type first

g1_vimp_bc_plot <- all_vimp_tidy_df_sam %>%
  filter(dgp_spec == "g1") %>%
  filter(variable %in% important_vimps_g1) %>%
  filter(type == "bc") %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() +
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = g1_labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(size = rel(0.8), angle = 90, hjust = 1)) +
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral",
                       limits = c(min(filter(all_vimp_tidy_df_sam, type == "bc")$importance), 
                                  max(filter(all_vimp_tidy_df_sam, type == "bc")$importance))
                       ) +
  facet_grid(rows = vars(cross_corr)) +
  ggtitle("g1")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g1_vimp_bc.pdf",
       width = 18, height = 6, units = "cm")

g2_vimp_bc_plot <- all_vimp_tidy_df_sam %>%
  filter(dgp_spec == "g2") %>%
  filter(variable %in% important_vimps_g1) %>%
  filter(type == "bc") %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() +
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = g2_labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(size = rel(0.8), angle = 90, hjust = 1)) +
  theme(axis.text.y = element_blank()) + 
  ylab("") + 
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral",
                       limits = c(min(filter(all_vimp_tidy_df_sam, type == "bc")$importance), 
                                  max(filter(all_vimp_tidy_df_sam, type == "bc")$importance))
                       ) +
  facet_grid(rows = vars(cross_corr)) +
  ggtitle("g2")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g2_vimp_bc.pdf",
       width = 8 * a4_aspect_ratio, height = 6, units = "cm")

g3_vimp_bc_plot <- all_vimp_tidy_df_sam %>%
  filter(dgp_spec == "g3") %>%
  filter(variable %in% important_vimps_g1) %>%
  filter(type == "bc") %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() +
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = g3_labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(size = rel(0.8), angle = 90, hjust = 1)) +
  theme(axis.text.y = element_blank()) + 
  ylab("") + 
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral",
                       limits = c(min(filter(all_vimp_tidy_df_sam, type == "bc")$importance), 
                                  max(filter(all_vimp_tidy_df_sam, type == "bc")$importance))
                       ) +
  facet_grid(rows = vars(cross_corr)) +
  ggtitle("g3")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g3_vimp_bc.pdf",
       width = 8 * a4_aspect_ratio, height = 6, units = "cm")

g1_vimp_bc_plot + g2_vimp_bc_plot + g3_vimp_bc_plot +
  plot_layout(guides = 'collect')
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g_vimp_bc.pdf",
       width = 18, height = 9, units = "cm")

#########

g1_vimp_ik_plot <- all_vimp_tidy_df_sam %>%
  filter(dgp_spec == "g1") %>%
  filter(variable %in% important_vimps_g1) %>%
  filter(type == "ik") %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() +
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = g1_labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(size = rel(0.8), angle = 90, hjust = 1)) +
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral",
                       limits = c(min(filter(all_vimp_tidy_df_sam, type == "ik")$importance), 
                                  max(filter(all_vimp_tidy_df_sam, type == "ik")$importance))
                       ) +
  theme(legend.position = "right") +
  facet_grid(rows = vars(cross_corr)) +
  ggtitle("g1")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g1_vimp_ik.pdf",
       width = 8 * a4_aspect_ratio, height = 6, units = "cm")

g2_vimp_ik_plot <- all_vimp_tidy_df_sam %>%
  filter(dgp_spec == "g2") %>%
  filter(variable %in% important_vimps_g1) %>%
  filter(type == "ik") %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() +
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = g2_labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(size = rel(0.8), angle = 90, hjust = 1)) +
  theme(axis.text.y = element_blank()) + 
  ylab("") + 
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral",
                       limits = c(min(filter(all_vimp_tidy_df_sam, type == "ik")$importance), 
                                  max(filter(all_vimp_tidy_df_sam, type == "ik")$importance))
                       ) +
  theme(legend.position = "right") +
  facet_grid(rows = vars(cross_corr)) +
  ggtitle("g2")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g2_vimp_ik.pdf",
       width = 8 * a4_aspect_ratio, height = 6, units = "cm")

g3_vimp_ik_plot <- all_vimp_tidy_df_sam %>%
  filter(dgp_spec == "g3") %>%
  filter(variable %in% important_vimps_g1) %>%
  filter(type == "ik") %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot() +
  geom_tile(aes(x = variable, y = model, fill = importance)) +
  scale_x_discrete(label = g3_labels, breaks = breaks) + 
  theme_bw() +
  theme(axis.text.x = element_text(size = rel(0.8), angle = 90, hjust = 1)) +
  theme(axis.text.y = element_blank()) + 
  ylab("") + 
  theme(legend.position = "right") +
  scale_fill_distiller(palette = "Spectral",
                       limits = c(min(filter(all_vimp_tidy_df_sam, type == "ik")$importance), 
                                  max(filter(all_vimp_tidy_df_sam, type == "ik")$importance))
                       ) +
  theme(legend.position = "right") +
  facet_grid(rows = vars(cross_corr)) +
  ggtitle("g3")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g3_vimp_ik.pdf",
       width = 8 * a4_aspect_ratio, height = 6, units = "cm")

g1_vimp_ik_plot + g2_vimp_ik_plot + g3_vimp_ik_plot +
  plot_layout(guides = 'collect')
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/simulation/graphics/simulation_g_vimp_ik.pdf",
       width = 18, height = 9, units = "cm")
```

```{r hyperparam_functions}
## Plotting hyperparameters of ELN across different training samples

# Function to extract ELN hyperparameter df from simulation results list

get_eln_hyper_df <- function(simulation_results_list, realization_no, dgp_spec, SV, cross_corr) {
  foreach(sample = 1:3, .combine = "rbind") %do% {
    rbind(
      cbind(realization_no = realization_no, sample = sample, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, model = "ELN_MSE",
            simulation_results_list[[realization_no]]$ELN_MSE[[sample]]$hyperparameters),
      cbind(realization_no = realization_no, sample = sample, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, model = "ELN_MAE",
            simulation_results_list[[realization_no]]$ELN_MAE[[sample]]$hyperparameters)
      )
  }
}

# Iterate this over all realizations

iterate_over_realization <- function(simulation_results_list, dgp_spec, SV, cross_corr) {
  foreach(realization_no = 1:10, .combine = "rbind") %do% {
    get_eln_hyper_df(simulation_results_list, realization_no = realization_no, dgp_spec, SV, cross_corr)
  }
}

eln_hyperparameters_df <- rbind(
  # iterate_over_realization(g1_A1_nosv_0_results_all, "g1", 0, 0),
  # iterate_over_realization(g2_A1_nosv_0_results_all, "g2", 0, 0),
  # iterate_over_realization(g3_A1_nosv_0_results_all, "g3", 0, 0),
  # 
  iterate_over_realization(g1_A1_sv_0.01_results_all, "g1", 1, 0.01),
  iterate_over_realization(g2_A1_sv_0.01_results_all, "g2", 1, 0.01),
  iterate_over_realization(g3_A1_sv_0.01_results_all, "g3", 1, 0.01),
  
  iterate_over_realization(g1_A1_sv_0.1_results_all, "g1", 1, 0.1),
  iterate_over_realization(g2_A1_sv_0.1_results_all, "g2", 1, 0.1),
  iterate_over_realization(g3_A1_sv_0.1_results_all, "g3", 1, 0.1),
  
  iterate_over_realization(g1_A1_sv_1_results_all, "g1", 1, 1),
  iterate_over_realization(g2_A1_sv_1_results_all, "g2", 1, 1),
  iterate_over_realization(g3_A1_sv_1_results_all, "g3", 1, 1)
)

## Alpha value plot
eln_hyperparameters_df %>%
  mutate(group_id = group_indices(., realization_no, model, dgp_spec, SV, cross_corr)) %>%
  mutate(group_id = as.factor(group_id)) %>%
  ggplot() +
  geom_line(aes(x = sample, y = alpha, group = group_id, colour = group_id)) +
  scale_x_continuous(breaks = c(1, 2, 3)) +
  theme_bw() +
  theme(legend.position = "none")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/eln_alpha_plot.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")

## Lambda Value Plot
eln_hyperparameters_df %>%
  mutate(group_id = group_indices(., realization_no, model, dgp_spec, SV, cross_corr)) %>%
  mutate(group_id = as.factor(group_id)) %>%
  ggplot() +
  geom_line(aes(x = sample, y = lambda, group = group_id, colour = group_id)) +
  scale_x_continuous(breaks = c(1, 2, 3)) +
  theme_bw() +
  theme(legend.position = "none")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/eln_lambda_plot.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")
```

```{r hyperparam_plots}
## Plotting hyperparameters of randomforest across training samples

get_rf_hyper_df <- function(simulation_results_list, realization_no, dgp_spec, SV, cross_corr) {
  foreach(sample = 1:3, .combine = "rbind") %do% {
    rbind(
      cbind(realization_no = realization_no, sample = sample, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, model = "RF_MSE",
            simulation_results_list[[realization_no]]$RF_MSE[[sample]]$hyperparameters),
      cbind(realization_no = realization_no, sample = sample, dgp_spec = dgp_spec, SV = SV, cross_corr = cross_corr, model = "RF_MAE",
            simulation_results_list[[realization_no]]$RF_MAE[[sample]]$hyperparameters)
      )
  }
}

iterate_over_realization <- function(simulation_results_list, dgp_spec, SV, cross_corr) {
  foreach(realization_no = 1:10, .combine = "rbind") %do% {
    get_rf_hyper_df(simulation_results_list, realization_no = realization_no, dgp_spec, SV, cross_corr)
  }
}

rf_hyperparameters_df <- rbind(
  # iterate_over_realization(g1_A1_nosv_0_results_all, "g1", 0, 0),
  # iterate_over_realization(g2_A1_nosv_0_results_all, "g2", 0, 0),
  # iterate_over_realization(g3_A1_nosv_0_results_all, "g3", 0, 0),
  
  iterate_over_realization(g1_A1_sv_0.01_results_all, "g1", 1, 0.01),
  iterate_over_realization(g2_A1_sv_0.01_results_all, "g2", 1, 0.01),
  iterate_over_realization(g3_A1_sv_0.01_results_all, "g3", 1, 0.01),
  
  iterate_over_realization(g1_A1_sv_0.1_results_all, "g1", 1, 0.1),
  iterate_over_realization(g2_A1_sv_0.1_results_all, "g2", 1, 0.1),
  iterate_over_realization(g3_A1_sv_0.1_results_all, "g3", 1, 0.1),
  
  iterate_over_realization(g1_A1_sv_1_results_all, "g1", 1, 1),
  iterate_over_realization(g2_A1_sv_1_results_all, "g2", 1, 1),
  iterate_over_realization(g3_A1_sv_1_results_all, "g3", 1, 1)
)

rf_hyperparameters_df %>%
  mutate(group_id = group_indices(., realization_no, model, dgp_spec, SV, cross_corr)) %>%
  mutate(group_id = as.factor(group_id)) %>%
  ggplot() +
  geom_line(aes(x = sample, y = mtry, group = group_id, colour = group_id)) +
  scale_x_continuous(breaks = c(1, 2, 3)) +
  theme_bw() +
  theme(legend.position = "none")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/rf_mtry_plot.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")

rf_hyperparameters_df %>%
  mutate(group_id = group_indices(., realization_no, model, dgp_spec, SV, cross_corr)) %>%
  mutate(group_id = as.factor(group_id)) %>%
  ggplot() +
  geom_line(aes(x = sample, y = nodesize, group = group_id, colour = group_id)) +
  scale_x_continuous(breaks = c(1, 2, 3)) +
  theme_bw() +
  theme(legend.position = "none")
ggsave("~/GitHub/Evaluation-of-Machine-Learning-in-Asset-Pricing/Results/rf_nodesize_plot.pdf",
       width = 15 * a4_aspect_ratio, height = 15, units = "cm")
```

